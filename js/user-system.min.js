($=>{var ReadingTracker={readingStarted:!1,readingTime:0,readingTimer:null,maxScrollPercent:0,contentHeight:0,windowHeight:0,postId:wp.currentPostId,expAwardedForTesting:!1,init:function(){$("#chapter-c")&&wp.isLoggedIn&&(this.checkReadingHistory(),this.contentHeight=$("#chapter-c").height(),this.windowHeight=$(window).height(),this.startReadingTimer(),$(window).on("scroll",function(){this.trackScrollPosition()}.bind(this)),$(window).on("beforeunload",this.saveReadingProgress.bind(this)),$(".chapter-navigation .next-chapter").on("click",this.completeReading.bind(this)),this.addMarkAsReadButton())},checkReadingHistory:function(){var historyKey="reading_history_"+this.postId,historyKey=localStorage.getItem(historyKey);historyKey&&!(historyKey=JSON.parse(historyKey)).expAwarded&&(this.readingTime=historyKey.readTime||0,this.maxScrollPercent=historyKey.scrollPercent||0)},saveReadingProgress:function(){var historyKey="reading_history_"+this.postId,data={readTime:this.readingTime,scrollPercent:this.maxScrollPercent,lastRead:(new Date).toISOString(),expAwarded:!1};localStorage.setItem(historyKey,JSON.stringify(data))},markExpAwarded:function(){var historyKey="reading_history_"+this.postId,history=localStorage.getItem(historyKey);history&&((history=JSON.parse(history)).expAwarded=!0,localStorage.setItem(historyKey,JSON.stringify(history)))},startReadingTimer:function(){this.readingStarted||(this.readingStarted=!0,this.readingTimer=setInterval(function(){this.readingTime++,this.readingTime%30==0&&this.saveReadingProgress()}.bind(this),1e3))},trackScrollPosition:function(){var scrollPercent;this.readingStarted&&(scrollPercent=$(window).scrollTop()/($(document).height()-this.windowHeight)*100)>this.maxScrollPercent&&50<(this.maxScrollPercent=scrollPercent)&&!this.expAwardedForTesting&&(this.expAwardedForTesting=!0,this.awardExperience())},completeReading:function(){this.readingTimer&&clearInterval(this.readingTimer);var minReadTime=this.calculateMinReadTime();if(this.readingTime>=minReadTime&&80<=this.maxScrollPercent)this.awardExperience();else{let message="";message=this.readingTime<minReadTime?"Bạn cần dành thêm thời gian để đọc chương này.":"Bạn cần đọc hết chương để nhận thưởng."}},calculateMinReadTime:function(){var wordCount=$("#chapter-c").text().trim().split(/\s+/).length;return Math.max(30,60*Math.ceil(wordCount/200))},awardExperience:function(){$.ajax({url:wp.ajaxUrl,type:"POST",data:{action:"award_reading_exp",post_id:this.postId,read_time:this.readingTime,scroll_percent:this.maxScrollPercent,nonce:wp.nonce},success:function(response){response.success&&this.markExpAwarded()}.bind(this)})},addMarkAsReadButton:function(){$(".chapter-navigation").append(`
                <button class="btn btn-primary mark-as-read">
                    <i class="glyphicon glyphicon-check"></i> Đánh dấu đã đọc
                </button>
            `),$(".mark-as-read").on("click",function(e){e.preventDefault(),this.completeReading()}.bind(this))}};$(document).ready(function(){ReadingTracker.init()})})(jQuery),($=>{let twFbComments={postId:null,currentPage:1,currentSort:"top",isLoading:!1,hasMore:!1,totalComments:0,currentUserAvatar:"",i18n:{replyText:"Trả lời",likeText:"Thích",likedText:"Đã thích",addComment:"Thêm bình luận...",writeReply:"Viết trả lời...",loadingComments:"Đang tải bình luận...",noComments:"Chưa có bình luận nào. Hãy là người đầu tiên bình luận!",loginToComment:'Vui lòng <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal">đăng nhập</a> để bình luận.',sortBy:"Sắp xếp theo:",top:"Hàng đầu",newest:"Mới nhất",oldest:"Cũ nhất",edited:"Đã chỉnh sửa",commentsCount:"Bình luận",loadMore:"Tải thêm bình luận"}};function initTwFbComments(){var $container=$("#fb-comment");$container.length&&(twFbComments.postId=$container.data("post-id"),twFbComments.postId?(wp&&wp.isLoggedIn&&(twFbComments.currentUserAvatar=wp.currentUserAvatar||wp.defaultAvatar||"https://secure.gravatar.com/avatar/?s=40&d=mm"),$container.data("chap-id")||(renderCommentsContainer($container),loadComments(),setupEventHandlers())):console.error("Không có ID bài viết cho bình luận"))}function renderCommentsContainer($container){var isLoggedIn=wp&&wp.isLoggedIn,chapId=$container.data("chap-id"),chapTitle=$container.data("chap-title"),chapId=`
    <div class="tw-fb-comments-container">
      <div class="tw-fb-comments-header">
        <div class="tw-fb-comments-count">
          <span class="comments-count-number">0</span> ${twFbComments.i18n.commentsCount}
          ${chapId&&chapTitle?` | <span class="tw-fb-chapter-info">
              <span class="tw-fb-chapter-title">Chương ${chapTitle}</span>
            </span>
          `:""}
        </div>
        <div class="tw-fb-comments-sort">
          <span>${twFbComments.i18n.sortBy}</span>
          <select class="tw-fb-sort-select">
            <option value="top">${twFbComments.i18n.top}</option>
            <option value="newest">${twFbComments.i18n.newest}</option>
            <option value="oldest">${twFbComments.i18n.oldest}</option>
          </select>
        </div>
      </div>
      
      <div class="tw-fb-comment-form-container">
        ${isLoggedIn?renderCommentForm():`<div class="tw-fb-login-prompt">${twFbComments.i18n.loginToComment}</div>`}
      </div>
      
      <div class="tw-fb-comment-list">
        <div class="tw-fb-comments-loading">
          <div class="spinner"></div>
          <p>${twFbComments.i18n.loadingComments}</p>
        </div>
      </div>
      
      <div class="tw-fb-comments-load-more" style="display: none;">
        <button class="btn btn-outline-primary btn-sm load-more-comments">
          ${twFbComments.i18n.loadMore}
        </button>
      </div>
    </div>
    `;$container.html(chapId)}function renderCommentForm(parentId=null){var placeholder=parentId?twFbComments.i18n.writeReply:twFbComments.i18n.addComment,inputClass=parentId?"tw-fb-reply-input":"",dataAttr=parentId?`data-parent-id="${parentId}"`:"";return`
      <div class="${parentId?"tw-fb-reply-form":"tw-fb-comment-form"}">
        <div class="user-avatar">
          <img src="${twFbComments.currentUserAvatar}" alt="Avatar của bạn">
        </div>
        <div class="tw-fb-comment-input-wrapper">
          <textarea class="tw-fb-comment-input ${inputClass}" placeholder="${placeholder}"></textarea>
          <button type="button" class="tw-fb-comment-submit btn btn-sm" ${dataAttr}>
            <i class="glyphicon glyphicon-send"></i> 
            ${twFbComments.i18n.addComment}
          </button>
        </div>
      </div>
    `}function loadComments(page=1,sort="top"){let $container=$("#fb-comment"),$commentList=$container.find(".tw-fb-comment-list");twFbComments.isLoading||(twFbComments.isLoading=!0,twFbComments.currentPage=page,twFbComments.currentSort=sort,1===page&&$commentList.html(`
        <div class="tw-fb-comments-loading">
          <div class="spinner"></div>
          <p>${twFbComments.i18n.loadingComments}</p>
        </div>
      `),$.ajax({url:wp.ajaxUrl,type:"POST",data:{action:"tw_get_fb_comments",post_id:twFbComments.postId,page:page,sort:sort},success:function(response){if(response.success){var data=response.data;if(twFbComments.hasMore=data.has_more,twFbComments.totalComments=data.total,$container.find(".comments-count-number").text(data.total),1===page?0===data.comments.length?$commentList.html(`<div class="tw-fb-no-comments">${twFbComments.i18n.noComments}</div>`):($commentList.empty(),data.comments.forEach(comment=>$commentList.append(renderComment(comment)))):data.comments.forEach(comment=>$commentList.append(renderComment(comment))),$container.find(".tw-fb-comments-load-more").toggle(data.has_more),data.is_logged_in&&wp&&wp.isLoggedIn){data=data.comments;let currentUserId=parseInt(wp.userId||0),findAvatar=commentList=>{for(var comment of commentList){if(comment.author.id===currentUserId)return twFbComments.currentUserAvatar=comment.author.avatar,updateCommentFormAvatars(),!0;if(comment.replies&&comment.replies.length&&findAvatar(comment.replies))return!0}return!1};findAvatar(data)}}else console.error("Lỗi khi tải bình luận:",response.data.message)},error:function(xhr,status,error){console.error("Lỗi AJAX:",error)},complete:function(){twFbComments.isLoading=!1,$container.find(".tw-fb-comments-loading").remove()}}))}function updateCommentFormAvatars(){$(".tw-fb-comment-form .user-avatar img, .tw-fb-reply-form .user-avatar img").attr("src",twFbComments.currentUserAvatar)}function renderComment(comment){var isReply=0<comment.parent_id,commentClass=isReply?"tw-fb-comment tw-fb-reply":"tw-fb-comment",likeText=comment.user_liked?twFbComments.i18n.likedText:twFbComments.i18n.likeText,likeClass=comment.user_liked?"tw-fb-comment-action liked":"tw-fb-comment-action",editedText=comment.is_edited?" · "+twFbComments.i18n.edited:"",chapInfo=comment.chap_title?`<span class="tw-fb-comment-chapter">Chương ${comment?.chap_title?.split(":")?.[0]?.trim()}</span>`:"";let html=`
    <div class="${commentClass}" id="comment-${comment.id}" data-id="${comment.id}">
      <div class="tw-fb-comment-avatar">
        <img src="${comment.author.avatar}" alt="${comment.author.name}">
      </div>
      <div class="tw-fb-comment-content">
        <div class="tw-fb-comment-bubble">
          <div class="tw-fb-comment-author">
            ${comment.author.name}
            ${comment.author.position?`<small>(${comment.author.position})</small>`:""}
            <span class="tw-fb-comment-level">Lv.${comment.author.level}</span>
            ${chapInfo}
          </div>
          <div class="tw-fb-comment-text">${comment.content}</div>
        </div>
        <div class="tw-fb-comment-actions">
          <span class="${likeClass}" data-action="like" data-comment-id="${comment.id}">
            ${likeText} ${0<comment.likes?"· "+comment.likes:""}
          </span>
          ${isReply?"":`<span class="tw-fb-comment-action" data-action="reply" data-comment-id="${comment.id}">${twFbComments.i18n.replyText}</span>`}
          <span class="tw-fb-comment-time">${comment.date} trước${editedText}</span>
        </div>
  `;return comment.replies&&0<comment.replies.length&&(html+='<div class="tw-fb-comment-replies">',comment.replies.forEach(reply=>{html+=renderComment(reply)}),html+="</div>"),isReply||(html+=`<div class="tw-fb-reply-form-container" id="reply-form-${comment.id}" style="display: none;"></div>`),html+="</div></div>"}function setupEventHandlers(){let $container=$("#fb-comment");$container.on("change",".tw-fb-sort-select",function(){loadComments(1,$(this).val())}),$container.on("click",".load-more-comments",function(){!twFbComments.isLoading&&twFbComments.hasMore&&loadComments(twFbComments.currentPage+1,twFbComments.currentSort)}),$container.on("keydown",".tw-fb-comment-input",function(e){e.stopPropagation(),13!==e.keyCode||e.shiftKey||(e.preventDefault(),$(this).closest(".tw-fb-comment-input-wrapper").find(".tw-fb-comment-submit").click())}),$container.on("click",".tw-fb-comment-submit",function(){if(wp&&wp.isLoggedIn){let $button=$(this),$input=$button.closest(".tw-fb-comment-input-wrapper").find(".tw-fb-comment-input");var content=$input.val().trim();if(content){$button.prop("disabled",!0);content={action:"tw_add_fb_comment",content:content,post_id:twFbComments.postId,chap_id:$("#fb-comment").data("chap-id")||0};let parentId=$button.data("parent-id");parentId&&(content.parent_id=parentId),$.ajax({url:wp.ajaxUrl,type:"POST",data:content,success:function(response){if(response.success){$input.val("");var newComment=response.data.comment;if(newComment.author.id===parseInt(wp.userId||0)&&(twFbComments.currentUserAvatar=newComment.author.avatar,updateCommentFormAvatars()),parentId){var $parentComment=$("#comment-"+parentId);let $repliesContainer=$parentComment.find(".tw-fb-comment-replies");$repliesContainer.length||($parentComment.find(".tw-fb-comment-content").append('<div class="tw-fb-comment-replies"></div>'),$repliesContainer=$parentComment.find(".tw-fb-comment-replies")),$repliesContainer.append(renderComment(newComment)),$("#reply-form-"+parentId).hide()}else{$parentComment=$container.find(".tw-fb-comment-list");$parentComment.find(".tw-fb-no-comments").remove(),$parentComment.prepend(renderComment(newComment))}twFbComments.totalComments++,$container.find(".comments-count-number").text(twFbComments.totalComments)}else alert(response.data.message)},error:function(){alert("Đã xảy ra lỗi. Vui lòng thử lại.")},complete:function(){$button.prop("disabled",!1)}})}}else $("#loginModal").modal("show")}),$container.on("click",'.tw-fb-comment-action[data-action="like"]',function(){if(wp&&wp.isLoggedIn){let $likeButton=$(this);var commentId=$likeButton.data("comment-id");$.ajax({url:wp.ajaxUrl,type:"POST",data:{action:"tw_like_fb_comment",comment_id:commentId},success:function(response){var isLiked;response.success&&(isLiked="liked"===response.data.action,response=0<response.data.likes?" · "+response.data.likes:"",$likeButton.toggleClass("liked",isLiked),$likeButton.html((isLiked?twFbComments.i18n.likedText:twFbComments.i18n.likeText)+response))}})}else $("#loginModal").modal("show")}),$container.on("click",'.tw-fb-comment-action[data-action="reply"]',function(){var commentId,$replyFormContainer;wp&&wp.isLoggedIn?(commentId=$(this).data("comment-id"),($replyFormContainer=$("#reply-form-"+commentId)).is(":visible")?$replyFormContainer.hide():($(".tw-fb-reply-form-container").hide(),$replyFormContainer.html(renderCommentForm(commentId)).show(),$replyFormContainer.find(".tw-fb-comment-input").focus())):$("#loginModal").modal("show")})}$(document).ready(initTwFbComments),$(".chapter-nav").on("click","button#chapter_comment",function(e){e.preventDefault(),renderCommentsContainer($("#fb-comment")),loadComments(),setupEventHandlers()})})(jQuery);