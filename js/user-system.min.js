($=>{var ReadingTracker={readingStarted:!1,readingTime:0,readingTimer:null,maxScrollPercent:0,contentHeight:0,windowHeight:0,postId:twUserSystem.currentPostId,expAwardedForTesting:!1,init:function(){$("#chapter-c")&&twUserSystem.isLoggedIn&&(this.checkReadingHistory(),this.contentHeight=$("#chapter-c").height(),this.windowHeight=$(window).height(),this.startReadingTimer(),$(window).on("scroll",function(){this.trackScrollPosition()}.bind(this)),$(window).on("beforeunload",this.saveReadingProgress.bind(this)),$(".chapter-navigation .next-chapter").on("click",this.completeReading.bind(this)),this.addMarkAsReadButton())},checkReadingHistory:function(){var historyKey="reading_history_"+this.postId,historyKey=localStorage.getItem(historyKey);historyKey&&!(historyKey=JSON.parse(historyKey)).expAwarded&&(this.readingTime=historyKey.readTime||0,this.maxScrollPercent=historyKey.scrollPercent||0)},saveReadingProgress:function(){var historyKey="reading_history_"+this.postId,data={readTime:this.readingTime,scrollPercent:this.maxScrollPercent,lastRead:(new Date).toISOString(),expAwarded:!1};localStorage.setItem(historyKey,JSON.stringify(data))},markExpAwarded:function(){var historyKey="reading_history_"+this.postId,history=localStorage.getItem(historyKey);history&&((history=JSON.parse(history)).expAwarded=!0,localStorage.setItem(historyKey,JSON.stringify(history)))},startReadingTimer:function(){this.readingStarted||(this.readingStarted=!0,this.readingTimer=setInterval(function(){this.readingTime++,this.readingTime%30==0&&this.saveReadingProgress()}.bind(this),1e3))},trackScrollPosition:function(){var scrollPercent;this.readingStarted&&(scrollPercent=$(window).scrollTop()/($(document).height()-this.windowHeight)*100)>this.maxScrollPercent&&50<(this.maxScrollPercent=scrollPercent)&&!this.expAwardedForTesting&&(this.expAwardedForTesting=!0,this.awardExperience())},completeReading:function(){this.readingTimer&&clearInterval(this.readingTimer);var minReadTime=this.calculateMinReadTime();if(this.readingTime>=minReadTime&&80<=this.maxScrollPercent)this.awardExperience();else{let message="";message=this.readingTime<minReadTime?"Bạn cần dành thêm thời gian để đọc chương này.":"Bạn cần đọc hết chương để nhận thưởng.",this.showNotification(message,!1)}},calculateMinReadTime:function(){var wordCount=$("#chapter-c").text().trim().split(/\s+/).length;return Math.max(30,60*Math.ceil(wordCount/200))},awardExperience:function(){$.ajax({url:twUserSystem.ajaxUrl,type:"POST",data:{action:"award_reading_exp",post_id:this.postId,read_time:this.readingTime,scroll_percent:this.maxScrollPercent,nonce:twUserSystem.nonce},success:function(response){response.success?(this.markExpAwarded(),this.showNotification(response.data.message,!0),response.data.level_up&&this.showLevelUpNotification(response.data.level)):this.showNotification(response.data.message,!1)}.bind(this),error:function(xhr,status,error){this.showNotification("Có lỗi xảy ra khi cập nhật kinh nghiệm.",!1)}.bind(this)})},showNotification:function(message,isSuccess){isSuccess=`
                <div class="alert alert-${isSuccess?"success":"info"} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;$("body").append(isSuccess),setTimeout(function(){$(".alert").alert("close")},5e3)},showLevelUpNotification:function(level){level=`
                <div class="alert alert-success alert-dismissible fade show position-fixed" 
                     style="top: 80px; right: 20px; z-index: 9999;">
                    <strong>🎉 Chúc mừng!</strong> Bạn đã lên Level ${level}!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;$("body").append(level),setTimeout(function(){$(".alert").alert("close")},5e3)},addMarkAsReadButton:function(){$(".chapter-navigation").append(`
                <button class="btn btn-primary mark-as-read">
                    <i class="glyphicon glyphicon-check"></i> Đánh dấu đã đọc
                </button>
            `),$(".mark-as-read").on("click",function(e){e.preventDefault(),this.completeReading()}.bind(this))}};$(document).ready(function(){ReadingTracker.init()})})(jQuery);