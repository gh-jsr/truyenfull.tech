const CACHE_NAME="truyen-cache-v1.7.3",CACHE_DURATION=3e5,PRECACHE_URLS=["/","/offline/","https://cdn.jsdelivr.net/","/manifest.json"];async function handleImageRequest(e){const t=await caches.open(CACHE_NAME),a=await t.match(e);if(a)return a;try{const a=await fetch(e);return a.ok&&await t.put(e,a.clone()),a}catch(e){return console.error("Error fetching image:",e),new Response("Image not available",{status:404})}}async function handleAssetRequest(e){try{const t=await fetch(e);if(t.ok){const a=await caches.open(CACHE_NAME);await a.put(e,t.clone())}return t}catch(t){console.error("Error fetching asset:",t);const a=await caches.open(CACHE_NAME),s=await a.match(e);return s||new Response("Asset not available",{status:404})}}async function handleRequest(e){try{const t=await caches.open(CACHE_NAME),a=await t.match(e);if(a){const s=a.headers.get("x-cache-timestamp"),n=Date.now();if(s&&n-parseInt(s)<3e5)return updateCacheInBackground(e,t),a;await t.delete(e)}const s=await fetch(e);if(s.ok){const a=s.clone(),n=new Headers(a.headers);n.set("x-cache-timestamp",Date.now().toString());const o=new Response(await a.blob(),{status:a.status,statusText:a.statusText,headers:n});return await t.put(e,o.clone()),o}return s}catch(t){console.error("Error in handleRequest:",t);const a=await caches.open(CACHE_NAME),s=await a.match(e);if(s)return s;if("navigate"===e.mode||e.headers.get("accept")&&e.headers.get("accept").includes("text/html")){const e=await a.match("/offline/");if(e)return e}return new Response("Hãy kiểm tra kết nối mạng của bạn",{status:503,statusText:"Service Unavailable"})}}async function updateCacheInBackground(e,t){try{const a=await fetch(e);if(a.ok){const s=a.clone(),n=new Headers(s.headers);n.set("x-cache-timestamp",Date.now().toString());const o=new Response(await s.blob(),{status:s.status,statusText:s.statusText,headers:n});await t.put(e,o)}}catch(e){console.error("Error updating cache in background:",e)}}async function handleFormSubmission(){try{const e=await getPendingForms();for(const t of e)try{(await fetch(t.url,{method:t.method||"POST",headers:t.headers||{"Content-Type":"application/x-www-form-urlencoded"},body:t.body})).ok&&await removePendingForm(t.id)}catch(e){console.error("Error submitting form:",e)}}catch(e){console.error("Error in handleFormSubmission:",e)}}async function getPendingForms(){return[]}async function removePendingForm(e){}self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(e=>e.addAll(PRECACHE_URLS))),self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==CACHE_NAME)return caches.delete(e)})))),self.clients.claim()}),self.addEventListener("fetch",e=>{if("GET"!==e.request.method)return;const t=new URL(e.request.url);t.origin.includes("chrome-extension")||t.hostname.includes("umami")||t.hostname.includes("spreadsheets")||t.pathname.startsWith("/api")||t.pathname.startsWith("/ajax")||t.pathname.startsWith("/wp-json")||t.pathname.startsWith("/wp-admin")||(t.pathname.match(/\.(jpg|jpeg|png|gif|webp|svg|ico)$/)?e.respondWith(handleImageRequest(e.request)):t.pathname.match(/\.(css|js)$/)?e.respondWith(handleAssetRequest(e.request)):e.respondWith(handleRequest(e.request)))}),self.addEventListener("message",e=>{e.data&&"CLEAR_CACHE"===e.data.type&&caches.delete(CACHE_NAME).then(()=>{e.ports&&e.ports[0]&&e.ports[0].postMessage({success:!0}),e.source&&e.source.postMessage({success:!0})}).catch(t=>{console.error("Error clearing cache:",t),e.ports&&e.ports[0]&&e.ports[0].postMessage({success:!1,error:t.message}),e.source&&e.source.postMessage({success:!1,error:t.message})})}),self.addEventListener("sync",e=>{"form-submission"===e.tag&&e.waitUntil(handleFormSubmission())}),self.addEventListener("push",e=>{if(!e.data)return;let t;try{t=e.data.json()}catch(a){t={title:"Thông báo mới",body:e.data.text()}}const a={body:t.body||"",icon:t.icon||"https://cdn.jsdelivr.net/gh/gh-jsr/truyenfull.tech@2.0.0/favicons/favicon-192x192.png",badge:"https://cdn.jsdelivr.net/gh/gh-jsr/truyenfull.tech@2.0.0/favicons/favicon-96x96.png",vibrate:[100,50,100],data:{url:t.url||"/"}};e.waitUntil(self.registration.showNotification(t.title,a))}),self.addEventListener("notificationclick",e=>{e.notification.close(),e.notification.data&&e.notification.data.url?e.waitUntil(clients.openWindow(e.notification.data.url)):e.waitUntil(clients.openWindow("/"))});