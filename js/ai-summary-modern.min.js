(s=>{var t={config:{debounceDelay:300,maxRetries:3,requestTimeout:3e4,nonceRefreshInterval:6e5},state:{isGenerating:!1,currentNonce:"undefined"!=typeof tw_summary_security?tw_summary_security.nonce:"",retryCount:0,containers:new Map},init:function(){this.bindEvents(),this.initializeContainers(),this.setupAccessibility(),this.startNonceRefresh()},bindEvents:function(){let e=this;s(document).on("change",".summary-type-select",this.debounce(function(){var t=s(this).closest(".tw-ai-summary-modern");e.updateFormState(t)},this.config.debounceDelay)),s(document).on("click",".generate-summary-btn:not(:disabled)",function(t){t.preventDefault(),e.state.isGenerating||(t=s(this).closest(".tw-ai-summary-modern"),e.handleSummaryGeneration(t))}),s(document).on("keydown",".summary-type-select",function(t){"Enter"!==t.key||(t=s(this).closest(".tw-ai-summary-modern").find(".generate-summary-btn")).prop("disabled")||t.trigger("click")}),s(document).on("input change",".summary-type-select",function(){var t=s(this).closest(".tw-ai-summary-modern");e.validateForm(t)})},initializeContainers:function(){let n=this;s(".tw-ai-summary-modern").each(function(t){var e=s(this),t="ai-summary-"+t;e.attr("data-container-id",t),n.state.containers.set(t,{element:e,initialized:!1}),n.initContainer(e)})},initContainer:function(t){t.data("is-logged-in"),t.data("guest-remaining");t.removeClass("loading generating error");let e=t.find(".summary-type-select");0<e.find("option[selected]").length&&setTimeout(()=>{e.trigger("change")},100),this.updateFormState(t),this.setupFormValidation(t);t=t.attr("data-container-id");t&&this.state.containers.has(t)&&(this.state.containers.get(t).initialized=!0)},updateFormState:function(t){var e=t.find(".summary-type-select"),n=t.find(".generate-summary-btn"),i=t.find(".well").first(),e=e.find("option:selected"),a=1===t.data("is-logged-in"),s=parseInt(e.data("cost"))||0,e=e.data("type");a&&i.length&&i.html('<strong>Chi phí:</strong> <span class="cost-amount">'+s+"</span> vàng"),e&&!this.state.isGenerating?this.enableButton(n):this.disableButton(n),a&&this.validateUserBalance(t,s),this.updateAccessibility(t,e,s)},validateUserBalance:function(t,e){var n=t.find(".well").last(),i=t.find(".generate-summary-btn"),n=n.text(),n=parseInt(n.match(/\d+/))||0;return n<e&&0<e?(this.disableButton(i),this.showInlineError(t,`Không đủ vàng. Cần ${e} vàng, bạn có ${n} vàng.`),!1):(this.hideInlineError(t),!0)},validateForm:function(t){var e=t.find(".summary-type-select"),n=e.find("option:selected").data("type"),i=1===t.data("is-logged-in");let a=n?!0:!1;return i&&n&&(n=parseInt(e.find("option:selected").data("cost"))||0,a=a&&this.validateUserBalance(t,n)),i||(t.data("guest-remaining")||0)<=0&&(a=!1,this.showRegistrationPrompt(t)),a},handleSummaryGeneration:function(t){var e,n;this.state.isGenerating||(this.validateForm(t)?(e=t.data("content-id"),n=t.find(".summary-type-select").find("option:selected").data("type"),e&&n?(this.state.isGenerating=!0,this.state.retryCount=0,this.showLoadingState(t),this.performSummaryRequest(t,e,n)):this.showError(t,"Vui lòng chọn loại tóm tắt hợp lệ.")):this.showError(t,"Vui lòng kiểm tra lại thông tin nhập vào."))},performSummaryRequest:function(i,t,e){let a=this;var n;this.state.currentNonce?(n={action:"chatgpt_summarize",content_id:parseInt(t,10),summary_type:this.sanitizeInput(e),nonce:this.state.currentNonce,_wp_http_referer:window.location.pathname,timestamp:Date.now()},n={url:"undefined"!=typeof tw_summary_security?tw_summary_security.ajax_url:"/wp-admin/admin-ajax.php",type:"POST",data:n,timeout:this.config.requestTimeout,headers:{"X-Requested-With":"XMLHttpRequest"},success:function(t){a.handleSuccess(i,t)},error:function(t,e,n){a.handleAjaxError(i,t,e,n)},complete:function(){a.state.isGenerating=!1,a.hideLoadingState(i)}},s.ajax(n)):this.refreshNonce().then(()=>{this.performSummaryRequest(i,t,e)}).catch(()=>{this.handleError(i,"Lỗi xác thực. Vui lòng tải lại trang.")})},handleSuccess:function(e,t){try{var n;t&&t.success&&t.data?(this.displayResult(e,t.data),this.updateUserInterface(e,t.data),this.logSuccess(t.data)):(n=t&&t.data&&t.data.message?t.data.message:"Có lỗi xảy ra khi tạo tóm tắt.",this.handleError(e,n),t&&t.data&&"INVALID_NONCE"===t.data.code&&this.refreshNonce())}catch(t){this.handleError(e,"Lỗi xử lý dữ liệu phản hồi."),this.logError("Response processing error: "+t.message)}},handleAjaxError:function(n,t,e,i){let a="Có lỗi kết nối. Vui lòng thử lại.",s=!1;switch(e){case"timeout":a="Yêu cầu quá thời gian. Vui lòng thử lại.",s=!0;break;case"error":429===t.status?a="Quá nhiều yêu cầu. Vui lòng chờ một chút.":500<=t.status?(a="Lỗi máy chủ. Vui lòng thử lại sau.",s=!0):403===t.status?(a="Không có quyền truy cập. Vui lòng tải lại trang.",this.refreshNonce()):0===t.status&&(a="Mất kết nối mạng. Vui lòng kiểm tra kết nối internet.");break;default:s=!0}s&&this.state.retryCount<this.config.maxRetries?(this.state.retryCount++,this.updateLoadingText(n,`Đang thử lại (${this.state.retryCount}/${this.config.maxRetries})...`),setTimeout(()=>{var t=n.data("content-id"),e=n.find(".summary-type-select option:selected").data("type");this.performSummaryRequest(n,t,e)},2e3*this.state.retryCount)):this.handleError(n,a)},displayResult:function(t,e){t=t.find(".ai-summary-result"),e=`
        <div class="alert alert-success">
          <h4><i class="fa fa-check-circle"></i> Kết quả tóm tắt AI</h4>
          <div class="summary-content">
            ${this.sanitizeHtml(e.summary)}
          </div>
          <div class="summary-meta">
            <small class="text-muted">
              Loại: ${e.summary_type} | Chi phí: ${e.cost||0} vàng | 
              Tokens: ${e.tokens_used||0} | Model: ${e.model_used||"unknown"}
            </small>
          </div>
        </div>
      `;t.html(e).show(),this.smoothScrollTo(t),t.find(".alert").hide().fadeIn(500),this.announceToScreenReader("Tóm tắt đã được tạo thành công")},updateUserInterface:function(t,e){var n=1===t.data("is-logged-in");n&&void 0!==e.remaining_gold?(t.find(".well").last().html('<i class="fa fa-coins"></i> <strong>'+e.remaining_gold+"</strong> vàng"),this.showSuccess(t,`Tóm tắt thành công! Số dư: ${e.remaining_gold} vàng`)):n||void 0===e.remaining_free_uses||(t.find(".alert-info").html('<i class="fa fa-star"></i> Còn <strong class="remaining-count">'+e.remaining_free_uses+"</strong> lượt miễn phí hôm nay"),t.data("guest-remaining",e.remaining_free_uses),0===e.remaining_free_uses?this.showRegistrationPrompt(t):this.showSuccess(t,`Còn lại ${e.remaining_free_uses} lượt miễn phí hôm nay`)),this.resetForm(t)},showLoadingState:function(t){var e=t.find(".generate-summary-btn"),n=t.find(".summary-loading");this.disableButton(e),e.find(".btn-text").hide(),e.find(".btn-loading").show(),0===n.length&&t.append(`
          <div class="summary-loading panel-body text-center">
            <div class="alert alert-info">
              <i class="fa fa-spinner fa-spin fa-2x"></i>
              <p class="loading-text">AI đang phân tích và tóm tắt nội dung...</p>
              <div class="progress">
                <div class="progress-bar progress-bar-striped active" style="width: 100%"></div>
              </div>
            </div>
          </div>
        `),t.find(".summary-loading").show(),this.announceToScreenReader("Bắt đầu tạo tóm tắt AI")},hideLoadingState:function(t){var e=t.find(".generate-summary-btn");e.find(".btn-loading").hide(),e.find(".btn-text").show(),t.find(".summary-loading").hide(),this.updateFormState(t)},updateLoadingText:function(t,e){t.find(".loading-text").text(e)},refreshNonce:function(){let i=this;return new Promise((e,n)=>{s.ajax({url:"undefined"!=typeof tw_summary_security?tw_summary_security.ajax_url:"/wp-admin/admin-ajax.php",type:"POST",data:{action:"get_summary_nonce"},timeout:1e4,success:function(t){t&&t.success&&t.data&&t.data.nonce?(i.state.currentNonce=t.data.nonce,e(t.data.nonce)):n(new Error("Invalid nonce response"))},error:function(){n(new Error("Failed to refresh nonce"))}})})},startNonceRefresh:function(){let t=this;setInterval(()=>{t.state.isGenerating||t.refreshNonce().catch(()=>{console.warn("Failed to refresh summary nonce")})},this.config.nonceRefreshInterval)},enableButton:function(t){t.prop("disabled",!1).removeClass("disabled").attr("aria-disabled","false")},disableButton:function(t){t.prop("disabled",!0).addClass("disabled").attr("aria-disabled","true")},showError:function(t,e){this.showMessage(t,e,"error")},showSuccess:function(t,e){this.showMessage(t,e,"success")},showMessage:function(t,e,n){t.find(".alert-message").remove();var i=`
        <div class="alert ${"error"===n?"alert-danger":"alert-success"} alert-message" role="alert" aria-live="polite">
          <i class="fa ${"error"===n?"fa-exclamation-triangle":"fa-check-circle"}" aria-hidden="true"></i>
          <span class="alert-text">${this.sanitizeHtml(e)}</span>
          <button type="button" class="close" onclick="$(this).parent().fadeOut()" aria-label="Đóng thông báo">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      `;t.prepend(i),"success"===n&&setTimeout(()=>{t.find(".alert-success").fadeOut()},5e3),this.announceToScreenReader(e)},showInlineError:function(t,e){this.hideInlineError(t);e=this.sanitizeHtml(e);t.find(".panel-body").append(`<div class="inline-error text-danger" role="alert"><i class="fa fa-exclamation-triangle"></i> ${e}</div>`)},hideInlineError:function(t){t.find(".inline-error").remove()},handleError:function(t,e){this.showError(t,e),this.logError(e)},resetForm:function(t){t.find(".summary-type-select").val("").trigger("change"),this.hideInlineError(t)},showRegistrationPrompt:function(t){t.find(".summary-form").hide(),t.find(".registration-prompt").show()},smoothScrollTo:function(t){t&&t.length&&t.offset()&&s("html, body").animate({scrollTop:t.offset().top-100},500)},setupFormValidation:function(t){t=t.find(".summary-type-select");t.on("invalid",function(){this.setCustomValidity("Vui lòng chọn loại tóm tắt")}),t.on("input change",function(){this.setCustomValidity("")})},setupAccessibility:function(){s(".summary-type-select").each(function(){var t=s(this);t.attr("aria-describedby")||t.attr("aria-describedby","summary-help")}),s(".generate-summary-btn").each(function(){var t=s(this);t.attr("aria-describedby")||t.attr("aria-describedby","btn-help")})},updateAccessibility:function(t,e,n){var i=t.find(".generate-summary-btn"),t=1===t.data("is-logged-in");let a="Tạo tóm tắt AI";e&&(a+=" loại "+e,t)&&0<n&&(a+=`, chi phí ${n} vàng`),i.attr("aria-label",a)},announceToScreenReader:function(t){let e=s("<div>",{"aria-live":"polite","aria-atomic":"true",class:"sr-only",text:t});s("body").append(e),setTimeout(()=>{e.remove()},1e3)},sanitizeInput:function(t){return"string"!=typeof t?"":t.replace(/[<>\"'&]/g,"")},sanitizeHtml:function(t){var e;return"string"!=typeof t?"":((e=document.createElement("div")).textContent=t,e.innerHTML)},debounce:function(e,n){let i;return function(...t){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),e.apply(this,t)},n)}},logSuccess:function(t){console&&console.log&&console.log("AI Summary Success:",{type:t.summary_type,cost:t.cost,tokensUsed:t.tokens_used,model:t.model_used})},logError:function(t){console&&console.error&&console.error("AI Summary Error:",t)}};window.openLoginModal=function(t){console.log("Open login modal:",t),"function"==typeof window.showLoginModal?window.showLoginModal(t):(t=s("#loginModal, .login-form, .user-forms")).length&&(t.show(),s("html, body").animate({scrollTop:t.offset().top-100},500))},s(document).ready(function(){0<s(".tw-ai-summary-modern").length&&t.init(),void 0!==window.TW_AISummary&&window.TW_AISummary.init()}),window.ModernAISummary=t})(jQuery);